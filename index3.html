<!DOCTYPE html>
<!--  Display rural water sources and calculate nearest source for fire dept tankers.   -->

<html>
<head>
<title>Loudoun County Rural Water Supply</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
<![endif]-->
<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="cilogi-marker.css">
<style>
	 html, body {height: 100%;}
	 .fill {min-height: 100%;height: 100%;}
</style>

</head> 
<body>

<nav class="navbar navbar-default navbar-inverse" role="navigation">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="#">Rural Water Supply</a>
  </div>

  <!-- Collect the nav links, forms, and other content for toggling -->
<div class="collapse navbar-collapse navbar-ex1-collapse">
	<form id="AddressForm" class="navbar-form navbar-left" role="search">
		<div class="form-group">
			<input type="text" id="addressInput" class="form-control input-sm" placeholder="Address:  123 Any Street">
		</div>
		<button type="submit" class="btn btn-default btn-sm">Submit</button>
	</form>
	<a data-toggle="modal" href="#myModal" class="btn btn-info btn-sm navbar-btn">Set Resources</a>
</div><!-- /.navbar-collapse -->
</nav>

  <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Set resources available</h4>
        </div>
	<div class="modal-body">
		<form class="form-inline" role="form">
			Number of Tankers:
			<select id="numTankers" class="form-control">
			  <option>1</option>
			  <option>2</option>
			  <option selected=TRUE>3</option>
			  <option>4</option>
			  <option>5</option>
			</select>
			Rated Capacity of each: 
			<div class="input-group">
				<input type="text" class="form-control" id="tankerCapacity" value = "3000">
				<span class="input-group-addon"> Gallons</span>
			</div>
		</form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->



	<div class="row">
		<div id="info" class="col-md-2">
			<h4>Information about the nearest water source.</h4>
		</div>
		<div id="mapwrapper" class="col-md-10">
			<div id="map"></div>
		</div> <!-- mapwrapper -->
	</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
<script src="http://www.mapquestapi.com/sdk/leaflet/v1.0/mq-map.js?key=Fmjtd%7Cluur2h6tnd%2Cb2%3Do5-9wa2lr"></script>
<script src="http://www.mapquestapi.com/sdk/leaflet/v1.0/mq-routing.js?key=Fmjtd%7Cluur2h6tnd%2Cb2%3Do5-9wa2lr"></script>
<script src="cilogi-marker.min.js"></script>
<script src="leaflet-knn.min.js"></script>


<script src="sources.geojson"></script>
<script>
var mapmargin = 50;
$('#map').css("height", ($(window).height() - mapmargin));
$(window).on("resize", resize);
resize();

document.getElementById('AddressForm').addEventListener('submit', function(ev) {
	ev.preventDefault();
	var addr = document.getElementById('addressInput').value;
	moveFire(addr);
});

function resize(){
        $('#map').css("height", ($(window).height() - (mapmargin+12)));    
        $('#map').css("margin-top",-21);
}
var fire, water, route;
var gpm, roundTripTime;

	var map = L.map('map').setView([ 39.12, -77.695], 11);
	var markers = [];
	var baseLayer = L.tileLayer('https://{s}.tiles.mapbox.com/v3/jasondalton.map-7z4qef6u/{z}/{x}/{y}.png', {
		attribution: 'Azimuth1',
		maxZoom: 22
	});
	var watersources;
	baseLayer.addTo(map);
	var baseballIcon = L.icon({
		iconUrl: 'baseball-marker.png',
		iconSize: [32, 37],
		iconAnchor: [16, 37],
		popupAnchor: [0, -28]
	});

	function onEachFeature(feature, layer) {
		var popupContent = "";

		if (feature.properties) {
			popupContent += "<table>";
			popupContent += "<tr><td>First Due: </td><td>"+feature.properties.RW_FIRSTDU+"</td></tr>";
			popupContent += "<tr><td>Type: </td><td>"+feature.properties.RW_TYPE+"</td></tr>";
			popupContent += "<tr><td>Size: </td><td>"+feature.properties.RW_SIZE+"</td></tr>";
			popupContent += "</table>";
		}

		layer.bindPopup(popupContent);
	}

	watersources = L.geoJson([sources], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},
		onEachFeature: onEachFeature,
		pointToLayer: function (feature, latlng) {
			return L.circleMarker(latlng, {
				radius: 8,
				fillColor: "#ff7800",
				color: "#000",
				weight: 1,
				opacity: 1,
				fillOpacity: 0.8
			});
		}
	});
	watersources.addTo(map);

	function getRoute(response) {
		var point, points = [];
         console.log(response);
      var numPoints = response.route.shape.shapePoints.length/2;
      
		for (var i=0; i<numPoints; i++) {
			point = new L.LatLng(response.route.shape.shapePoints[2*i] , response.route.shape.shapePoints[2*i+1]);
			points.push(point);
		}
		route= new L.Polyline(points, {
			weight: 3,
			opacity: 0.5,
			smoothFactor: 1
		}).addTo(map);
		route.bringToFront();

		roundTripTime = (response.route_summary["total_time"]/60)*2;  //1 way * 2
		gpm = calcGPM(document.getElementById('numTankers').value,document.getElementById('tankerCapacity').value,roundTripTime);
		directions = [];
		for (var step in response.route_instructions) {
			directions.push(response.route_instructions[step][0]);
		}
		infoString = "<h4>Information about the nearest water source.</h4><p class='lead'>GPM: " + gpm +"</p><p>Round trip: "+ roundTripTime.toFixed(2) +" minutes.</p><p><ol><li>"+directions.join("</li><li></i> ")+"</li></ol></p>"
		document.getElementById('info').innerHTML = infoString;
	}

	function addScript(url) {
		script = document.createElement('script');
		script.type="text/javascript";
		script.src=url;
		document.getElementsByTagName('head') [0].appendChild(script);
	}

 
	function computeSizeFromZoom() {
		var max = map.getMaxZoom(),
		zoom = map.getZoom(),
		diff = max - zoom,
		table = [4, 2, 1];
		return  (diff < table.length) ? table[diff] : 1;
	}

	var index = leafletKnn(watersources);

	var firePt = new L.latLng([39.195, -77.6]);
        fire = new cilogi.L.Marker(firePt,{
		draggable: true, 
		fontIconSize: computeSizeFromZoom(),
		fontIconName: "\uf06D", // fire
		fontIconColor: "#990000",
		fontIconFont: 'awesome',
		opacity: 1
	})
	fire.addTo(map);
	
function getNearestWater(fire){
	firePt = L.latLng(fire.getLatLng());
	var closest = index.nearest(firePt, 1);
	var waterPt = closest[0];
        water = new cilogi.L.Marker(waterPt,{
		fontIconSize: computeSizeFromZoom(),
		fontIconName: "\uf043", //water drop
		fontIconColor: "#000099",
		fontIconFont: 'awesome',
		opacity: 1
	})
	water.addTo(map);

dir = MQ.routing.directions();
 
dir.route({
    locations: [
        { latLng: { lat: firePt.lat, lng: firePt.lon } },
        { latLng: { lat: waterPt.lat, lng: waterPt.lon } }
    ]
});
route = MQ.routing.routeLayer({
    directions: dir,
    fitBounds: true
});
  
map.addLayer(route);
}
  
function calcGPM(tankerCount, tankerCapacity, roundTripTime){
	console.log(parseInt(tankerCount) + "|" + parseInt(tankerCapacity) + "|" + roundTripTime);
	var fillTime = 2.5;
	var dumpTime = 2.5;
	var tempGpm = (tankerCount * tankerCapacity*0.8)/(roundTripTime+dumpTime+fillTime);
	return tempGpm.toFixed(2);
}

function moveFire(addr){
	$.getJSON("http://nominatim.openstreetmap.org/search?q="+addr.split(' ').join('+')+"&format=json", function( data ) {
		fire.setLatLng([parseFloat(data[0].lat), parseFloat(data[0].lon)]); 
	});
	map.removeLayer(water);
	map.removeLayer(route);
	getNearestWater(fire);
}

fire.on('dragend', function(event) {
	//console.log(fire.getLatLng());
	map.removeLayer(water);
	map.removeLayer(route);
	getNearestWater(fire);
});


getNearestWater(fire);

</script>
</body>
</html>


