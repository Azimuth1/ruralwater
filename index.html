<!DOCTYPE html>
<!--  Display rural water sources and calculate nearest source for fire dept tankers.   -->

<html>
<head>
<title>FireRoute - Loudoun County</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
<script src="http://maps.google.com/maps/api/js?v=3&sensor=false"></script>
<!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
<![endif]-->
<link rel="stylesheet" href="leaflet-routing-machine.css" />
<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="cilogi-marker.css">
<style>
	 html, body {height: 100%;}
	 .fill {min-height: 100%;height: 100%;}
</style>

</head> 
<body>

<nav class="navbar navbar-default navbar-inverse" role="navigation">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="#">FireRoute</a>
  </div>

  <!-- Collect the nav links, forms, and other content for toggling -->
<div class="collapse navbar-collapse navbar-ex1-collapse">
	<form id="AddressForm" class="navbar-form navbar-left" role="search">
		<div class="form-group">
			<input type="text" id="addressInput" class="form-control input-sm" placeholder="Address:  123 Any Street">
		</div>
		<button type="submit" class="btn btn-default btn-sm">Submit</button>
	</form>
	<a data-toggle="modal" href="#myModal" class="btn btn-info btn-sm navbar-btn">Set Resources</a>
</div><!-- /.navbar-collapse -->
</nav>

  <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Set resources available</h4>
        </div>
	<div class="modal-body">
		<form class="form-inline" role="form">
			Number of Tankers:
			<select id="numTankers" class="form-control">
			  <option>1</option>
			  <option>2</option>
			  <option selected=TRUE>3</option>
			  <option>4</option>
			  <option>5</option>
			</select>
			Rated Capacity of each: 
			<div class="input-group">
				<input type="text" class="form-control" id="tankerCapacity" value = "3000">
				<span class="input-group-addon"> Gallons</span>
			</div>
		</form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->



	<div class="row">
		<div id="info" class="col-md-2">
			<h4>Information about the nearest water source.</h4>
		</div>
		<div id="mapwrapper" class="col-md-10">
			<div id="map"></div>
		</div> <!-- mapwrapper -->
	</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>

<script src="leaflet-routing-machine.js"></script>
<script src="cilogi-marker.min.js"></script>
<script src="leaflet-knn.min.js"></script>


<script src="sources.geojson"></script>
<script>
/*
 * Google layer using Google Maps API
 */

/* global google: true */

L.Google = L.Class.extend({
	includes: L.Mixin.Events,

	options: {
		minZoom: 0,
		maxZoom: 22,
		maxnativeZom: 20,
		tileSize: 256,
		subdomains: 'abc',
		errorTileUrl: '',
		attribution: '',
		opacity: 1,
		continuousWorld: false,
		noWrap: false,
		mapOptions: {
			backgroundColor: '#dddddd'
		}
	},

	// Possible types: SATELLITE, ROADMAP, HYBRID, TERRAIN
	initialize: function(type, options) {
		L.Util.setOptions(this, options);

		this._ready = google.maps.Map !== undefined;
		if (!this._ready) L.Google.asyncWait.push(this);

		this._type = type || 'SATELLITE';
	},

	onAdd: function(map, insertAtTheBottom) {
		this._map = map;
		this._insertAtTheBottom = insertAtTheBottom;

		// create a container div for tiles
		this._initContainer();
		this._initMapObject();

		// set up events
		map.on('viewreset', this._resetCallback, this);

		this._limitedUpdate = L.Util.limitExecByInterval(this._update, 150, this);
		map.on('move', this._update, this);

		map.on('zoomanim', this._handleZoomAnim, this);

		//20px instead of 1em to avoid a slight overlap with google's attribution
		map._controlCorners.bottomright.style.marginBottom = '20px';

		this._reset();
		this._update();
	},

	onRemove: function(map) {
		map._container.removeChild(this._container);

		map.off('viewreset', this._resetCallback, this);

		map.off('move', this._update, this);

		map.off('zoomanim', this._handleZoomAnim, this);

		map._controlCorners.bottomright.style.marginBottom = '0em';
	},

	getAttribution: function() {
		return this.options.attribution;
	},

	setOpacity: function(opacity) {
		this.options.opacity = opacity;
		if (opacity < 1) {
			L.DomUtil.setOpacity(this._container, opacity);
		}
	},

	setElementSize: function(e, size) {
		e.style.width = size.x + 'px';
		e.style.height = size.y + 'px';
	},

	_initContainer: function() {
		var tilePane = this._map._container,
			first = tilePane.firstChild;

		if (!this._container) {
			this._container = L.DomUtil.create('div', 'leaflet-google-layer leaflet-top leaflet-left');
			this._container.id = '_GMapContainer_' + L.Util.stamp(this);
			this._container.style.zIndex = 'auto';
		}

		tilePane.insertBefore(this._container, first);

		this.setOpacity(this.options.opacity);
		this.setElementSize(this._container, this._map.getSize());
	},

	_initMapObject: function() {
		if (!this._ready) return;
		this._google_center = new google.maps.LatLng(0, 0);
		var map = new google.maps.Map(this._container, {
			center: this._google_center,
			zoom: 0,
			tilt: 0,
			mapTypeId: google.maps.MapTypeId[this._type],
			disableDefaultUI: true,
			keyboardShortcuts: false,
			draggable: false,
			disableDoubleClickZoom: true,
			scrollwheel: false,
			streetViewControl: false,
			styles: this.options.mapOptions.styles,
			backgroundColor: this.options.mapOptions.backgroundColor
		});

		var _this = this;
		this._reposition = google.maps.event.addListenerOnce(map, 'center_changed',
			function() { _this.onReposition(); });
		this._google = map;

		google.maps.event.addListenerOnce(map, 'idle',
			function() { _this._checkZoomLevels(); });
		//Reporting that map-object was initialized.
		this.fire('MapObjectInitialized', { mapObject: map });
	},

	_checkZoomLevels: function() {
		//setting the zoom level on the Google map may result in a different zoom level than the one requested
		//(it won't go beyond the level for which they have data).
		// verify and make sure the zoom levels on both Leaflet and Google maps are consistent
		if (this._google.getZoom() !== this._map.getZoom()) {
			//zoom levels are out of sync. Set the leaflet zoom level to match the google one
			this._map.setZoom( this._google.getZoom() );
		}
	},

	_resetCallback: function(e) {
		this._reset(e.hard);
	},

	_reset: function(clearOldContainer) {
		this._initContainer();
	},

	_update: function(e) {
		if (!this._google) return;
		this._resize();

		var center = this._map.getCenter();
		var _center = new google.maps.LatLng(center.lat, center.lng);

		this._google.setCenter(_center);
		this._google.setZoom(Math.round(this._map.getZoom()));

		this._checkZoomLevels();
	},

	_resize: function() {
		var size = this._map.getSize();
		if (this._container.style.width === size.x &&
				this._container.style.height === size.y)
			return;
		this.setElementSize(this._container, size);
		this.onReposition();
	},


	_handleZoomAnim: function (e) {
		var center = e.center;
		var _center = new google.maps.LatLng(center.lat, center.lng);

		this._google.setCenter(_center);
		this._google.setZoom(Math.round(e.zoom));
	},


	onReposition: function() {
		if (!this._google) return;
		google.maps.event.trigger(this._google, 'resize');
	}
});

L.Google.asyncWait = [];
L.Google.asyncInitialize = function() {
	var i;
	for (i = 0; i < L.Google.asyncWait.length; i++) {
		var o = L.Google.asyncWait[i];
		o._ready = true;
		if (o._container) {
			o._initMapObject();
			o._update();
		}
	}
	L.Google.asyncWait = [];
};




var mapmargin = 50;
$('#map').css("height", ($(window).height() - mapmargin));
$(window).on("resize", resize);
resize();

document.getElementById('AddressForm').addEventListener('submit', function(ev) {
	ev.preventDefault();
	var addr = document.getElementById('addressInput').value;
	moveFire(addr);
});


function resize(){
        $('#map').css("height", ($(window).height() - (mapmargin+12)));    
        $('#map').css("margin-top",-21);
}

var fire, water, route;
var gpm, roundTripTime;

	var map = L.map('map').setView([ 39.12, -77.695], 11);
	var markers = [];
	var baseLayer = L.tileLayer('http://api.tiles.mapbox.com/v4/jasondalton.map-7z4qef6u/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiamFzb25kYWx0b24iLCJhIjoiMnNBSWg4VSJ9.NMibCJgR_WkdcmfsD3ceGg', {
		attribution: 'Azimuth1',
		maxZoom: 22
	});


var ggl = new L.Google('HYBRID');
//var ggl2 = new L.Google('TERRAIN');
map.addLayer(ggl);
//map.addControl(new L.Control.Layers( { 'Google':ggl, 'Google Terrain':ggl2}, {}));


/*
    var routerControl = L.Routing.control({
        fitSelectedRoutes: false,
   	});
    routerControl.addTo(map);
*/

	var watersources;
	//baseLayer.addTo(map);
	var baseballIcon = L.icon({
		iconUrl: 'baseball-marker.png',
		iconSize: [32, 37],
		iconAnchor: [16, 37],
		popupAnchor: [0, -28]
	});

	function onEachFeature(feature, layer) {
		var popupContent = "";

		if (feature.properties) {
			popupContent += "<table>";
			popupContent += "<tr><td>First Due: </td><td>"+feature.properties.RW_FIRSTDU+"</td></tr>";
			popupContent += "<tr><td>Type: </td><td>"+feature.properties.RW_TYPE+"</td></tr>";
			popupContent += "<tr><td>Size: </td><td>"+feature.properties.RW_SIZE+"</td></tr>";
			popupContent += "</table>";
		}

		layer.bindPopup(popupContent);
	}

	watersources = L.geoJson([sources], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},
		onEachFeature: onEachFeature,
		pointToLayer: function (feature, latlng) {
			return L.circleMarker(latlng, {
				radius: 6,
				fillColor: "#0078ff",
				color: "#000",
				weight: 1,
				opacity: 1,
				fillOpacity: 0.75
			});
		}
	});
	watersources.addTo(map);

 
	function computeSizeFromZoom() {
		var max = map.getMaxZoom(),
		zoom = map.getZoom(),
		diff = max - zoom,
		table = [4, 2, 1];
		return  (diff < table.length) ? table[diff] : 1;
	}

	var index = leafletKnn(watersources);

	var firePt = new L.latLng([39.195, -77.6]);
        fire = new cilogi.L.Marker(firePt,{
		draggable: true, 
		fontIconSize: computeSizeFromZoom(),
		fontIconName: "\uf06D", // fire
		fontIconColor: "#990000",
		fontIconFont: 'awesome',
		opacity: 1
	})
	fire.addTo(map);
	

function getNearestWater(fire,cb){


var candidateDist = [];
var candidateRoutes = [];

	firePt = L.latLng(fire.getLatLng());
	firePt = L.latLng(fire.getLatLng());
	var closest = index.nearest(firePt, 10); 
	var count = 0;
	var length = closest.length;
//	var closest = index.nearest(firePt, 1);
	//console.log(closest);
	router = L.Routing.osrm();
	closest.forEach( function (candidate){
	    var x = candidate.lat + " " + candidate.lon;
    	// check candidates for travel time 
		
		waypoints = [{
			latLng: firePt
		}, {
			latLng: L.latLng(candidate.lat, candidate.lon)
		}];

		router.route(waypoints, function(err, routes) {
			count++;
			candidateDist.push(routes[0].summary.totalTime);
			candidateRoutes.push(routes[0]);

		
		if(count==length){
    		cb(candidateDist,candidateRoutes);
    	}


		})
	});


}
  

function calcGPM(tankerCount, tankerCapacity, roundTripTime){  // tankerCount (integer count), tankerCapacity (gallons), roundTripTime (minutes)
	//console.log(parseInt(tankerCount) + "|" + parseInt(tankerCapacity) + "|" + roundTripTime);
	var fillTime = 2.5;
	var dumpTime = 2.5;
	var tempGpm = (tankerCount * tankerCapacity*0.8)/(roundTripTime+dumpTime+fillTime);
	return tempGpm.toFixed(2);
}

function moveFire(addr){
	//$.getJSON("http://nominatim.openstreetmap.org/search?q="+addr.split(' ').join('+')+"&format=json&viewbox=-77.968296,39.328613,-77.318729,38.841471", function( data ) {
	$.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="+addr.split(' ').join('+')+"&bounds=-118.604794,34.172684|-118.500938,34.236144&key=AIzaSyA6UX3-mKx_AXCMZCH4h9sGHai3mc9SNV8", function( data ) {
		var pt = data.results[0];
		//console.log(pt);
		fire.setLatLng([parseFloat(pt.geometry.location.lat), parseFloat(pt.geometry.location.lng)]); 
		map.removeLayer(water);
		map.removeLayer(routeLayer);  // remove the old route
		getNearestWater(fire, compareRoutes);
	});
}

fire.on('dragend', function(event) {
	map.removeLayer(water);
	map.removeLayer(routeLayer);  // remove the old route
	getNearestWater(fire, compareRoutes);
});



function compareRoutes(candidateDist,candidateRoutes){
		console.log(candidateDist,candidateRoutes);
		console.log("Shortest Element: "+candidateDist.indexOf(Math.min.apply(Math, candidateDist)));
		console.log("Shortest Dist: "+Math.min.apply(Math, candidateDist));
		var r = candidateRoutes[candidateDist.indexOf(Math.min.apply(Math, candidateDist))];
		gpm = calcGPM(document.getElementById('numTankers').value,document.getElementById('tankerCapacity').value,r.summary.totalTime/60);
		routeLayer = L.Routing.line(r).addTo(map);
		infoString = "<h4>Information about the nearest water source.</h4><p class='lead'>GPM: " + gpm +"</p><p>Round trip: "+ Math.round(r.summary.totalTime/60,2) +" minutes.</p><p><ol><li>";

	    for (i = 0; i < r.instructions.length; ++i) {
	    	step = r.instructions[i];
	    	if (step.type == "DestinationReached"){
	    		infoString += "Arrive at Destination ";
	    		continue;
	    	}
	        infoString += step.type + " " + step.direction + " on " + step.road + " for " + step.distance + " feet.</li><li></i> ";
	    } 
	    infoString += "</li></ol></p>";
		document.getElementById('info').innerHTML = infoString;

		var waterPt = L.latLng([r.waypoints[1][0],r.waypoints[1][1]]);
		console.log("water source index: "+candidateDist.indexOf(Math.min.apply(Math, candidateDist)))
	    water = new cilogi.L.Marker(waterPt,{
			fontIconSize: computeSizeFromZoom(),
			fontIconName: "\uf043", //water drop
			fontIconColor: "#000099",
			fontIconFont: 'awesome',
			opacity: 1
		})
		water.addTo(map);
};


getNearestWater(fire,compareRoutes);

</script>
</body>
</html>


