<!DOCTYPE html>
<!--  Display rural water sources and calculate nearest source for fire dept tankers.   -->
<html>

<head>
    <title>FireRoute - Loudoun County</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="shortcut icon" href="favicon.ico" />
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
    <script src="//maps.google.com/maps/api/js?v=3&sensor=false"></script>
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
<![endif]-->
    <link href='https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
    <!--<link rel="stylesheet" href="leaflet-routing-machine.css" />-->
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="cilogi-marker.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <style>
    .map-legend {
        width: 240px;
    }
    
    .legend label,
    .legend span {
        display: block;
        float: left;
        height: 15px;
        width: 20%;
        text-align: center;
        font-size: 10px;
        color: #808080;
    }
    </style>
</head>

<body>
    <nav class="navbar navbar-default navbar-inverse" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <form id="AddressForm" class="navbar-form navbar-left" role="search">
                <div class="form-group">
                    <input type="text" id="addressInput" class="form-control input-sm" placeholder="Addr: 123 Any Street">
                </div>
                <button type="submit" class="btn btn-default btn-sm btn-submit">Submit</button>
            </form>
            <a data-toggle="modal" href="#myModal" class="btn btn-info btn-sm navbar-btn btn-resources">Set Water Shuttle Resources </a>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="http://azimuth1.com">Created by
                        <img src="Azimuth1_color_small.png" style="vertical-align:text-bottom" class="img-rounded" alt="Azimuth1">
                    </a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </nav>
    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Set resources available</h4>
                </div>
                <div class="modal-body">
                    <form class="form-inline" role="form">
                        Number of Tankers:
                        <select id="numTankers" class="form-control">
                            <option>1</option>
                            <option>2</option>
                            <option selected=TRUE>3</option>
                            <option>4</option>
                            <option>5</option>
                        </select>
                        Rated Capacity of each:
                        <div class="input-group">
                            <input type="text" class="form-control" id="tankerCapacity" value="3000">
                            <span class="input-group-addon"> Gallons</span>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-submit" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary btn-resources">Save changes</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
    </div>
    <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
    <div class="row">
        <div id="info" class="col-md-3 infobox">
            <a href="http://fireroute.us">
                <img src="fireroute-logo.png" alt="FireRoute">
            </a>
            <h4>Information about the nearest water source.</h4>
        </div>
        <div id='legend' style='display:none;'>
            <div class='legend'>
                <strong>FireRoute Model</strong>
                <nav class='legend_ clearfix'>
                    <span style='background:#d53e4f;'></span>
                    <span style='background:#fc8d59;'></span>
                    <span style='background:#fee08b;'></span>
                    <span style='background:#e6f598;'></span>
                    <span style='background:#99d594;'></span>
                    <label>0-350</label>
                    <label>350-450</label>
                    <label>450-550</label>
                    <label>550-650</label>
                    <label>>650</label>
                    <small>Gallons/Minute
                    </small>
                </nav>
            </div>
        </div>
        <div id="mapwrapper" class="col-md-9">
            <div id="map"></div>
        </div>
        <!-- mapwrapper -->
    </div>
    <div class="topo splashBG"></div>
    <div id="splash" class="topo"></div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <!--<script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>-->
    <script src='https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.js'></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
    <script src="leaflet-routing-machine.js"></script>
    <script src="cilogi-marker.min.js"></script>
    <script src="leaflet-knn.min.js"></script>
    <script src="sources.geojson"></script>
    <!-- <script src="random.geojson"></script> -->
    <script>
    L.mapbox.accessToken = 'pk.eyJ1IjoibWFwcGlza3lsZSIsImEiOiI0OGU3NTI2ZDFkOTU2YmNlYTFmNGM4YTM2Y2NhNWM1NCJ9.UNhVkkf5Bd6SfOSESXvtMQ';
    /*
     * Google layer using Google Maps API
     */

    /* global google: true */

    L.Google = L.Class.extend({
        includes: L.Mixin.Events,

        options: {
            minZoom: 0,
            maxZoom: 22,
            maxnativeZom: 20,
            tileSize: 256,
            subdomains: 'abc',
            errorTileUrl: '',
            attribution: '',
            opacity: 1,
            continuousWorld: false,
            noWrap: false,
            mapOptions: {
                backgroundColor: '#dddddd'
            }
        },

        // Possible types: SATELLITE, ROADMAP, HYBRID, TERRAIN
        initialize: function(type, options) {
            L.Util.setOptions(this, options);

            this._ready = google.maps.Map !== undefined;
            if (!this._ready) L.Google.asyncWait.push(this);

            this._type = type || 'SATELLITE';
        },

        onAdd: function(map, insertAtTheBottom) {
            this._map = map;
            this._insertAtTheBottom = insertAtTheBottom;

            // create a container div for tiles
            this._initContainer();
            this._initMapObject();

            // set up events
            map.on('viewreset', this._resetCallback, this);

            this._limitedUpdate = L.Util.limitExecByInterval(this._update, 150, this);
            map.on('move', this._update, this);

            map.on('zoomanim', this._handleZoomAnim, this);

            //20px instead of 1em to avoid a slight overlap with google's attribution
            map._controlCorners.bottomright.style.marginBottom = '20px';

            this._reset();
            this._update();
        },

        onRemove: function(map) {
            map._container.removeChild(this._container);

            map.off('viewreset', this._resetCallback, this);

            map.off('move', this._update, this);

            map.off('zoomanim', this._handleZoomAnim, this);

            map._controlCorners.bottomright.style.marginBottom = '0em';
        },

        getAttribution: function() {
            return this.options.attribution;
        },

        setOpacity: function(opacity) {
            this.options.opacity = opacity;
            if (opacity < 1) {
                L.DomUtil.setOpacity(this._container, opacity);
            }
        },

        setElementSize: function(e, size) {
            e.style.width = size.x + 'px';
            e.style.height = size.y + 'px';
        },

        _initContainer: function() {
            var tilePane = this._map._container,
                first = tilePane.firstChild;

            if (!this._container) {
                this._container = L.DomUtil.create('div', 'leaflet-google-layer leaflet-top leaflet-left');
                this._container.id = '_GMapContainer_' + L.Util.stamp(this);
                this._container.style.zIndex = 'auto';
            }

            tilePane.insertBefore(this._container, first);

            this.setOpacity(this.options.opacity);
            this.setElementSize(this._container, this._map.getSize());
        },

        _initMapObject: function() {
            if (!this._ready) return;
            this._google_center = new google.maps.LatLng(0, 0);
            var map = new google.maps.Map(this._container, {
                center: this._google_center,
                zoom: 0,
                tilt: 0,
                mapTypeId: google.maps.MapTypeId[this._type],
                disableDefaultUI: true,
                keyboardShortcuts: false,
                draggable: false,
                disableDoubleClickZoom: true,
                scrollwheel: false,
                streetViewControl: false,
                styles: this.options.mapOptions.styles,
                backgroundColor: this.options.mapOptions.backgroundColor
            });

            var _this = this;
            this._reposition = google.maps.event.addListenerOnce(map, 'center_changed',
                function() {
                    _this.onReposition();
                });
            this._google = map;

            google.maps.event.addListenerOnce(map, 'idle',
                function() {
                    _this._checkZoomLevels();
                });
            //Reporting that map-object was initialized.
            this.fire('MapObjectInitialized', {
                mapObject: map
            });
        },

        _checkZoomLevels: function() {
            //setting the zoom level on the Google map may result in a different zoom level than the one requested
            //(it won't go beyond the level for which they have data).
            // verify and make sure the zoom levels on both Leaflet and Google maps are consistent
            if (this._google.getZoom() !== this._map.getZoom()) {
                //zoom levels are out of sync. Set the leaflet zoom level to match the google one
                this._map.setZoom(this._google.getZoom());
            }
        },

        _resetCallback: function(e) {
            this._reset(e.hard);
        },

        _reset: function(clearOldContainer) {
            this._initContainer();
        },

        _update: function(e) {
            if (!this._google) return;
            this._resize();

            var center = this._map.getCenter();
            var _center = new google.maps.LatLng(center.lat, center.lng);

            this._google.setCenter(_center);
            this._google.setZoom(Math.round(this._map.getZoom()));

            this._checkZoomLevels();
        },

        _resize: function() {
            var size = this._map.getSize();
            if (this._container.style.width === size.x &&
                this._container.style.height === size.y)
                return;
            this.setElementSize(this._container, size);
            this.onReposition();
        },


        _handleZoomAnim: function(e) {
            var center = e.center;
            var _center = new google.maps.LatLng(center.lat, center.lng);

            this._google.setCenter(_center);
            this._google.setZoom(Math.round(e.zoom));
        },


        onReposition: function() {
            if (!this._google) return;
            google.maps.event.trigger(this._google, 'resize');
        }
    });

    L.Google.asyncWait = [];
    L.Google.asyncInitialize = function() {
        var i;
        for (i = 0; i < L.Google.asyncWait.length; i++) {
            var o = L.Google.asyncWait[i];
            o._ready = true;
            if (o._container) {
                o._initMapObject();
                o._update();
            }
        }
        L.Google.asyncWait = [];
    };




    var mapmargin = 50;
    $('#map').css("height", ($(window).height() - mapmargin));
    $(window).on("resize", resize);
    resize();

    document.getElementById('AddressForm').addEventListener('submit', function(ev) {
        ev.preventDefault();
        var addr = document.getElementById('addressInput').value;
        moveFire(addr);
    });


    function resize() {
        $('#map').css("height", ($(window).height() - (mapmargin + 12)));
        $('#map').css("margin-top", -21);
    }

    var fire;
    var water;
    var route;
    var routeLayer;
    var gpm, roundTripTime;


    var baseURL = 'https://api.mapbox.com/v4/jasondalton.map-7z4qef6u/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoia3lsZS1hemltdXRoMSIsImEiOiJiNjgwODliZmJmZGQyYjcyYjhhYzFkN2M4MTZjNjlkZSJ9.j4_XYU-hkLlAepVI6cRHew';
    var baseLayer = L.tileLayer(baseURL, {
        attribution: 'Azimuth1',
        maxZoom: 22
    });


    var map = L.mapbox.map('map', 'jasondalton.map-7z4qef6u', {
        attributionControl: false
    });
    map.setView([37.63163475580643, -99.11865234374999], 5);
    //map.setView([39.12, -77.695], 12);



    var markers = [];
    /*var baseLayer = L.tileLayer('http://api.tiles.mapbox.com/v4/jasondalton.map-7z4qef6u/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiamFzb25kYWx0b24iLCJhIjoiMnNBSWg4VSJ9.NMibCJgR_WkdcmfsD3ceGg', {
        attribution: 'Azimuth1',
        maxZoom: 22
    });*/


    //var ggl = new L.Google('HYBRID');
    //var ggl2 = new L.Google('TERRAIN');
    //map.addLayer(ggl);
    //map.addControl(new L.Control.Layers( { 'Google':ggl, 'Google Terrain':ggl2}, {}));


    /*
        var routerControl = L.Routing.control({
            fitSelectedRoutes: false,
        });
        routerControl.addTo(map);
    */


    //var myGridLayer = L.mapbox.tileLayer('mappiskyle.nh2c6h4o').addTo(map);
    //var myGridLayer = L.mapbox.gridLayer('mappiskyle.nh2c6h4o').addTo(map);
    //var myGridControl = L.mapbox.gridControl(myGridLayer).addTo(map);
    //map.legendControl.addLegend(document.getElementById('legend').innerHTML);



    var layerControl = L.control.layers({}, {
        'Flow Distribution': L.mapbox.tileLayer('mappiskyle.nh2a4c2k'),
        //'Bike Lanes': L.mapbox.tileLayer('examples.bike-lanes')
    }, {
        position: 'topright',
        collapsed: false
    });
    layerControl.addTo(map);
    var myGridLayer = L.mapbox.gridLayer('mappiskyle.nh2a4c2k'); //.addTo(map);
    var myGridControl = L.mapbox.gridControl(myGridLayer);
    map.on('overlayadd', function(layer) {
        myGridLayer.addTo(map);
        myGridControl.addTo(map);
        //$('.map-legend').show();
        map.legendControl.addLegend(document.getElementById('legend').innerHTML);
    });

    map.on('overlayremove', function(layer) {
        map.removeLayer(myGridLayer);
        myGridControl.removeFrom(map);
        map.legendControl.removeLegend(document.getElementById('legend').innerHTML);
        //$('.map-legend').hide();
    });


    var watersources;
    //baseLayer.addTo(map);
    var baseballIcon = L.icon({
        iconUrl: 'baseball-marker.png',
        iconSize: [32, 37],
        iconAnchor: [16, 37],
        popupAnchor: [0, -28]
    });

    function onEachFeature(feature, layer) {
        var popupContent = "";

        if (feature.properties) {
            popupContent += "<table>";
            popupContent += "<tr><td>First Due: </td><td>" + feature.properties.RW_FIRSTDU + "</td></tr>";
            popupContent += "<tr><td>Type: </td><td>" + feature.properties.RW_TYPE + "</td></tr>";
            popupContent += "<tr><td>Size: </td><td>" + feature.properties.RW_SIZE + "</td></tr>";
            popupContent += "</table>";
        }

        layer.bindPopup(popupContent);
    }

    // return color based on value
    function getValue(x) {
        return x === "TANK" ? "#ff8d00" :
            x === "POND" ? "#0078ff" :
            "#FFEDA0";
    }

    // style function 
    function waterStyle(feature) {
        return {
            color: "#0078ff",
            //"stroke": false
            radius: 5,
            fillColor: getValue(feature.properties.RW_TYPE),
            weight: 1,
            opacity: 1,
            fillOpacity: 0.85
        };
    }

    watersources = L.geoJson([sources], {
        style: function(feature) {
            return feature.properties && feature.properties.style;
        },
        onEachFeature: onEachFeature,
        pointToLayer: function(feature, latlng) {
            var ws = waterStyle(feature);
            return L.circleMarker(latlng, ws);
        }
    });
    watersources.addTo(map);


    function computeSizeFromZoom() {
        var max = map.getMaxZoom(),
            zoom = map.getZoom(),
            diff = max - zoom,
            table = [4, 2, 1];
        return (diff < table.length) ? table[diff] : 1;
    }

    var index = leafletKnn(watersources);

    var firePt = new L.latLng([39.115, -77.66]);
    fire = new cilogi.L.Marker(firePt, {
        draggable: true,
        fontIconSize: computeSizeFromZoom(),
        fontIconName: "\uf06D", // fire
        fontIconColor: "#990000",
        fontIconFont: 'awesome',
        opacity: 1
    })
    fire.addTo(map);


    function getNearestWater(fire, cb) {
        var candidateDist = [];
        var candidateRoutes = [];

        firePt = L.latLng(fire.getLatLng());
        var closest = index.nearest(firePt, 10);
        var count = 0;
        var length = closest.length;
        router = L.Routing.osrm();
        closest.forEach(function(candidate) {
            var x = candidate.lat + " " + candidate.lon;
            waypoints = [{
                latLng: firePt
            }, {
                latLng: L.latLng(candidate.lat, candidate.lon)
            }];

            router.route(waypoints, function(err, routes) {
                count++;
                candidateDist.push(routes[0].summary.totalTime);
                candidateRoutes.push(routes[0]);
                if (count == length) {
                    cb(candidateDist, candidateRoutes);
                }
            })
        });
    }



    function calcGPM(tankerCount, tankerCapacity, roundTripTime) { // tankerCount (integer count), tankerCapacity (gallons), roundTripTime (minutes)
        //console.log(parseInt(tankerCount) + "|" + parseInt(tankerCapacity) + "|" + roundTripTime);
        var fillTime = 2.5;
        var dumpTime = 2.5;
        var tempGpm = (tankerCount * tankerCapacity * 0.8) / (roundTripTime + dumpTime + fillTime);
        return tempGpm.toFixed(2);
    }

    function moveFire(addr) {
        //$.getJSON("http://nominatim.openstreetmap.org/search?q="+addr.split(' ').join('+')+"&format=json&viewbox=-77.968296,39.328613,-77.318729,38.841471", function( data ) {
        $.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address=" + addr.split(' ').join('+') + "&bounds=-118.604794,34.172684|-118.500938,34.236144&key=AIzaSyA6UX3-mKx_AXCMZCH4h9sGHai3mc9SNV8", function(data) {
            //$.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="+addr.split(' ').join('+')+"&bounds=-77.968296,39.328613|-77.318729,38.841471&key=AIzaSyA6UX3-mKx_AXCMZCH4h9sGHai3mc9SNV8", function( data ) {
            var pt = data.results[0];
            //console.log(pt);
            fire.setLatLng([parseFloat(pt.geometry.location.lat), parseFloat(pt.geometry.location.lng)]);
            map.removeLayer(water);
            map.removeLayer(routeLayer); // remove the old route


            getNearestWater(fire, compareRoutes, addr);
        });
    }


    function simFire(lat, lon) {
        fire.setLatLng([lat, lon]);
        map.removeLayer(water);
        map.removeLayer(routeLayer); // remove the old route
        getNearestWater(fire, compareRoutes);
    }

    function simGeoJSON(geojson) {
        geojson.features.forEach(function(row) {
            simFire(row.geometry.coordinates[1], row.geometry.coordinates[0]);
        });
    }

    fire.on('dragend', function(event) {
        map.removeLayer(water);
        map.removeLayer(routeLayer); // remove the old route
        getNearestWater(fire, compareRoutes);
    });

    function compareRoutes(candidateDist, candidateRoutes) {
        //console.log(candidateDist,candidateRoutes);
        //console.log("Shortest Element: "+candidateDist.indexOf(Math.min.apply(Math, candidateDist)));
        //console.log("Dist,"+Math.min.apply(Math, candidateDist)+);
        var r = candidateRoutes[candidateDist.indexOf(Math.min.apply(Math, candidateDist))];
        gpm = calcGPM(document.getElementById('numTankers').value, document.getElementById('tankerCapacity').value, (r.summary.totalTime / 60) * 2);
        console.log("gpm," + gpm + "," + r.waypoints[0][0] + "," + r.waypoints[0][1]);
        routeLayer = L.Routing.line(r).addTo(map);
        infoString = "<a href='http://fireroute.us'><img src='fireroute-logo.png' alt='FireRoute'></a><h4>Information about the nearest water source.</h4><p class='lead'>GPM: " + gpm + "</p><p>Round trip: " + Math.round(r.summary.totalTime / 60, 2) + " minutes.</p><p><ol><li>";

        for (i = 0; i < r.instructions.length; ++i) {
            step = r.instructions[i];
            //console.log(step);
            if (step.type == "DestinationReached") {
                infoString += "Arrive at Destination ";
                continue;
            }
            infoString += step.type + " " + step.direction + " on " + step.road + " for " + (step.distance * 0.000621371).toFixed(2) + " miles.</li><li></i> "; //multiply to go from meters to miles
        }
        infoString += "</li></ol></p>";
        document.getElementById('info').innerHTML = infoString;

        var waterPt = L.latLng([r.waypoints[1][0], r.waypoints[1][1]]);
        //console.log("water source index: "+candidateDist.indexOf(Math.min.apply(Math, candidateDist)))
        water = new cilogi.L.Marker(waterPt, {
            fontIconSize: computeSizeFromZoom(),
            fontIconName: "\uf043", //water drop
            fontIconColor: "#000099",
            fontIconFont: 'awesome',
            opacity: 1
        })
        water.addTo(map);


        //////Zoom to Bounds
        var p1 = L.latLng(r.waypoints[1][0], r.waypoints[1][1]);
        var p2 = L.latLng(r.waypoints[0][0], r.waypoints[0][1]);
        map.panInsideBounds(L.latLngBounds(p1, p2))
            //////
    };


    getNearestWater(fire, compareRoutes);





    var USTopo = function(elem) {
        var activeState;
        var activeCounty;
        var activeFeature;
        var height = d3.select(elem).node().offsetHeight;
        var width = d3.select(elem).node().offsetWidth;
        /*d3.select(elem).append("div").attr("class", "splashHeader").append('div').attr("class", 'text-info h3')
            .text('Select State/County to get started with FireRoute');
*/
        var header = d3.select(elem).append("div").attr("class", "splashHeader"); //.style('top', '40px');
        /*
        header.append('div').attr("class", 'text-info h3')
                    .text('Select State/County to get started with FireRoute');*/
        stateText = header.append('div').attr("class", 'text-primary h1'); //.text('Select State');
        var countyText = header.append('div').attr("class", 'em h2'); //.text('Select State');;
        var startBtn = header.append('button').attr("class", 'btn btn-primary hide').text('Start FireRoute!');;
        var centered;
        var projection = d3.geo.albersUsa()
            .scale(1070)
            .translate([width / 2, height / 2]);
        var path = d3.geo.path()
            .projection(projection);
        var svg = d3.select(elem).append("svg")
            .attr("width", width)
            .attr("height", height);
        svg.append("rect")
            .attr("class", "background")
            .attr("width", width)
            .attr("height", height)
            .on("click", clicked);
        var g = svg.append("g");
        d3.json("us-topo-counties.json", function(error, us) {
            a = us
            d3.json("us-topo-states.json", function(error, st) {
                g.append("g")
                    .attr("id", "counties")
                    .selectAll("path")
                    .data(topojson.feature(us, us.objects['us-counties']).features)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("class", "county-boundary")
                    .on("click", countyclicked)
                    .on("mouseover", mouseoverCounty);
                g.append("g")
                    .attr("id", "states")
                    .selectAll("path")
                    .data(topojson.feature(st, st.objects['us-states']).features)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("class", "state")
                    .on("click", clicked)
                    .on("mouseover", mouseoverState);
                g.append("path")
                    .datum(topojson.mesh(st, st.objects['us-states'], function(a, b) {
                        return a !== b;
                    }))
                    .attr("id", "state-borders")
                    .attr("d", path);
            });
        });

        function mouseoverState(d, e) {
            if (activeState) {
                return;
            }

            d3.selectAll('.state').classed('hover', false);
            d3.select(this).classed('hover', true);

            stateText.text(d.properties.NAME);
            countyText.text('');
        }

        function mouseoverCounty(d) {

            if (!activeState || activeCounty) {
                return;
            }

            d3.selectAll('.county-boundary').classed('hover', false);
            d3.select(this).classed('hover', true);
            var type = d.properties.LSAD;
            countyText.text(d.properties.NAME + ' ' + type);
        }

        function clicked(d) {
            startBtn.classed('hide', true);
            d3.selectAll('path').classed('hover', false);
            d3.selectAll('path').classed('active2', false);
            countyText.text('');
            activeCounty = false;
            var x, y, k;
            if (d && centered !== d) {
                var centroid = path.centroid(d);
                x = centroid[0];
                y = centroid[1];
                k = 4;
                centered = d;
                activeState = d.properties.NAME;
                stateText.text(d.properties.NAME);

            } else {
                x = width / 2;
                y = height / 2;
                k = 1;
                centered = null;
                activeState = false;
                stateText.text('');

            }
            g.selectAll("path")
                .classed("active", centered && function(d) {
                    return d === centered;
                });
            g.transition()
                .duration(750)
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
                .style("stroke-width", 1.5 / k + "px");
        }

        function countyclicked(d) {
            activeFeature = d;

            if (!activeState) {
                return;
            }
            d3.selectAll('.county-boundary').classed('hover', false);

            activeCounty = d.properties.NAME;
            var x, y, k;
            if (d && centered !== d) {
                var centroid = path.centroid(d);
                x = centroid[0];
                y = centroid[1];
                k = 9;
                centered = d;
                activeCounty = d.properties.NAME;
                var type = d.properties.LSAD;
                countyText.text(d.properties.NAME + ' ' + type);
            } else {
                x = width / 2;
                y = height / 2;
                k = 10;
                centered = null;
                activeCounty = false;

            }
            g.selectAll("path")
                .classed("active2", centered && function(d) {
                    return d === centered;
                });
            g.transition()
                .duration(750)
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
                .style("stroke-width", 1.5 / k + "px");
            startBtn.classed('hide', false);
        }




        startBtn.on('click', function() {

            var coords = _.flatten(activeFeature.geometry.coordinates, 1);
            countyBounds = L.latLngBounds(coords.map(function(d) {
                return L.latLng([d[1], d[0]]);
            }));
            $('.topo').hide('slow', function() {
                // return map.panTo(countyBounds.getCenter());
                setTimeout(function() {
                    map.fitBounds(countyBounds);
                    //map.panTo(countyBounds.getCenter());
                }, 500);
                //return map.fitBounds(countyBounds);
            });


            /*customLayer = L.geoJson(null, {
                style: function(feature) {
                    return {
                        fillOpacity: 0,
                        color: '#08415F',
                        weight: 8
                    };
                },
                filter: function(d, e) {
                    return d.properties.NAME === activeCounty;

                }
            }).on('ready', function() {
                map.fitBounds(customLayer.getBounds())
            }).addTo(map);
            var myLayer = omnivore.topojson("us-topo-counties.json", null, customLayer);*/
            //map.panTo(customLayer.getBounds().getCenter())




        });






    };

    USTopo('#splash');
    //$('.topo').hide('slow');
    </script>
</body>

</html>
